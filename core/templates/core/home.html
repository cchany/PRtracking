<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>월 PR 분석 자동반영</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0f172a;              /* 단일 다크 배경 */
    --card:#111827;            /* 카드 배경 */
    --line:#1f2933;
    --brand:#38bdf8;           /* 포인트 컬러 */
    --text:#e5e7eb;
    --muted:#9ca3af;
    --radius:16px;
    --shadow:0 12px 30px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  html,body{height:100%}

  body{
    margin:0;
    font-family:"Pretendard", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  /* container */
  .wrap{
    max-width:1200px;
    margin:54px auto;
    padding:0 22px 44px;
  }

  /* header */
  .hero{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:18px;
    margin-bottom:16px;
  }

  h1{
    font-size:28px;
    letter-spacing:-.02em;
    margin:0;
    font-weight:900;
    line-height:1.05;
  }

  .subtitle{
    margin:10px 0 0;
    color:var(--muted);
    font-size:14px;
  }

  /* 오른쪽 상단 배지(있다면) */
  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border:1px solid rgba(56,189,248,.35);
    background:rgba(56,189,248,.08);
    color:var(--brand);
    border-radius:999px;
    font-weight:800;
    user-select:none;
    white-space:nowrap;
  }
  .badge .dot{
    width:9px; height:9px; border-radius:50%;
    background:var(--brand);
    box-shadow:0 0 0 0 rgba(56,189,248,.35);
    animation: dotPing 1.6s ease-out infinite;
  }
  @keyframes dotPing{
    0%{box-shadow:0 0 0 0 rgba(56,189,248,.35)}
    70%{box-shadow:0 0 0 12px rgba(56,189,248,0)}
    100%{box-shadow:0 0 0 0 rgba(56,189,248,0)}
  }

  /* step progress (top) */
  .steps{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:14px;
    margin:18px 0 18px;
    padding:14px;
    border:1px solid var(--line);
    border-radius:18px;
    background:var(--card);
    box-shadow:var(--shadow);
  }

  .step{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:#020617;
    transition: transform .18s ease, box-shadow .22s ease, border-color .22s ease;
  }
  .step:hover{
    transform:translateY(-2px);
    box-shadow:0 14px 38px rgba(0,0,0,.35);
    border-color:rgba(56,189,248,.35);
  }

  .circle{
    width:38px; height:38px;
    border-radius:999px;
    background:rgba(56,189,248,.12);
    color:var(--brand);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    border:1px solid rgba(56,189,248,.25);
  }

  .step span{
    font-weight:900;
    letter-spacing:-.01em;
  }

  /* === 3-column layout === */
  .tri{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:18px;
    align-items:stretch;
  }

  /* cards */
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:22px;
    box-shadow:var(--shadow);
    position:relative;
    overflow:hidden;
    min-height:520px;
    transition: transform .18s ease, box-shadow .22s ease, border-color .22s ease;
  }
  .card:hover{
    transform:translateY(-2px);
    box-shadow:0 18px 44px rgba(0,0,0,.40);
    border-color:rgba(56,189,248,.28);
  }

  .card h2{
    font-size:18px;
    margin:0 0 10px;
    letter-spacing:-.02em;
  }
  .card p{
    color:var(--muted);
    font-size:14px;
    margin:0 0 16px;
  }

  /* form */
  form{display:flex; flex-direction:column; gap:10px;}
  label{
    font-weight:900;
    font-size:13px;
    margin:8px 0 0;
    letter-spacing:-.01em;
  }

  input[type="file"], input[type="number"], input[type="text"], textarea, select{
    width:100%;
    padding:12px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:#020617;
    color:var(--text);
    outline:none;
    transition: box-shadow .22s ease, border-color .22s ease, transform .12s ease;
  }
  input[type="file"]{padding:10px}
  input:focus, textarea:focus, select:focus{
    border-color:rgba(56,189,248,.55);
    box-shadow:0 0 0 5px rgba(56,189,248,.12);
  }
  input:active, textarea:active{transform:scale(.995)}

  button{
    margin-top:8px;
    padding:12px 16px;
    border:none;
    border-radius:12px;
    font-weight:900;
    letter-spacing:-.01em;
    color:#020617;
    background:linear-gradient(90deg,#38bdf8,#0ea5e9);
    cursor:pointer;
    width:100%;
    box-shadow:0 14px 30px rgba(0,0,0,.25);
    transition: transform .18s ease, box-shadow .22s ease, filter .22s ease;
  }
  button:hover{
    transform: translateY(-1px);
    box-shadow:0 20px 44px rgba(0,0,0,.35);
    filter:saturate(1.05);
  }
  button:active{transform: translateY(0px) scale(.99)}
  button[disabled]{
    background:#334155;
    color:#cbd5e1;
    cursor:not-allowed;
    box-shadow:none;
  }

  .footer{
    text-align:center;
    color:#94a3b8;
    font-size:12px;
    margin-top:28px;
  }

  /* Loading overlay (news_collect와 동일 톤) */
  .loading-overlay{
    position:fixed;
    inset:0;
    background:rgba(2,6,23,.92);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9999;
    opacity:0;
    pointer-events:none;
    transition: opacity .25s ease;
  }
  .loading-overlay.active{opacity:1; pointer-events:auto;}

  .loader-text{
    font-size:18px;
    font-weight:900;
    margin-bottom:18px;
    color:var(--brand);
    letter-spacing:-.02em;
    text-align:center;
  }

  .progress-shell{
    width:min(420px, 86vw);
    padding:14px;
    border-radius:18px;
    border:1px solid var(--line);
    background:#020617;
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  .progress-bar{
    width:100%;
    height:12px;
    background:#020617;
    border-radius:999px;
    overflow:hidden;
  }

  .progress-inner{
    width:38%;
    height:100%;
    background:linear-gradient(90deg,#38bdf8,#0ea5e9);
    animation: indeterminate 1.1s infinite ease-in-out;
    transform: translateX(-120%);
  }

  @keyframes indeterminate{
    0%{ transform: translateX(-120%); }
    100%{ transform: translateX(280%); }
  }

  /* responsive */
  @media (max-width: 1060px){
    .tri{grid-template-columns:1fr;}
    .card{min-height:auto}
    .badge{display:none}
  }
</style>

</head>
<body>
<div class="wrap">
  <div class="hero">
    <div>
      <h1>PR Tracking System</h1>
      <p class="subtitle">PR Tracking Program</p>
    </div>
    <a class="badge" href="{% url 'news_collect' %}">
      <span class="dot"></span> Naver News API
    </a>
  </div>

  <!-- Step Progress -->
  <div class="steps">
    <div class="step"><div class="circle">1</div><span>자동 분류</span></div>
    <div class="step"><div class="circle">2</div><span>work sheet 분석</span></div>
    <div class="step"><div class="circle">3</div><span>★ 마스터 파일 업데이트</span></div>
  </div>

  <!-- 3 columns -->
  <div class="tri">
    <!-- Step 1 -->
    <div class="card">
      <h2>Step 1. raw data & "월 PR 분석.xslx" 파일 업로드</h2>
      <p>자동으로 시트명·기간·카테고리를 반영한 결과 파일을 생성합니다.</p>
      <form id="step1-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="step" value="1">
        <label>월 (1-12)</label>
        {{ form.month }}
        <label>raw data File</label>
        {{ form.raw_file }}
        <label>월 PR 분석 File</label>
        {{ form.monthly_file }}
        <button type="submit">분석 실행 & 다운로드</button>
      </form>
    </div>

    <!-- Step 2 -->
    <div class="card">
      <h2>Step 2. 검수본 업로드</h2>
      <p>Step 1에서 다운 받은 파일에서 "미분류" 카테고리 검수 후 업로드. <br/>*_work 시트를 분석합니다.</p>
      <form id="step2-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="step" value="2">
        <label>검수 완료 파일</label>
        <input type="file" name="checked_file" accept=".xlsx" required>
        <button type="submit">월 PR Tracking File 완성본 다운로드</button>
      </form>
    </div>

    <!-- Step 3 -->
    <div class="card">
      <h2>Step 3. 마스터 반영</h2>
      <p>검수 완료본과 마스터 파일을 업로드해 최종 반영본을 만듭니다.</p>
      <form id="step3-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="step" value="3">
        <label>검수 완료 파일</label>
        <input type="file" name="checked_file_step3" accept=".xlsx" required>
        <label>마스터 파일</label>
        <input type="file" name="master_file" accept=".xlsx" required>
        <label>기간 (예: Dec-25)</label>
        <input type="text" name="period" placeholder="Dec-25" required
               pattern="^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-\d{2}$">
        <button type="submit">Master File Download</button>
      </form>
    </div>
  </div>

  <div class="footer">© 2025 PR Auto Analysis</div>
</div>

<!-- 로딩 오버레이 -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loader-text" id="loader-text">분석 중입니다...</div>
  <div class="progress-shell">
    <div class="progress-bar"><div class="progress-inner"></div></div>
  </div>
</div>

<script>
  function showLoading(message) {
    const overlay = document.getElementById("loading-overlay");
    const text = document.getElementById("loader-text");
    if (text && message) text.textContent = message;
    if (overlay) overlay.classList.add("active");
  }

  function hideLoading() {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) overlay.classList.remove("active");
  }

  function getFilenameFromDisposition(disposition) {
    if (!disposition) return null;
    const utf8Match = disposition.match(/filename\*\s*=\s*UTF-8''([^;]+)/i);
    if (utf8Match && utf8Match[1]) {
      try { return decodeURIComponent(utf8Match[1].replace(/['"]/g, "").trim()); } catch(e) {}
    }
    const asciiMatch = disposition.match(/filename\s*=\s*"?([^"]+)"?/i);
    if (asciiMatch && asciiMatch[1]) return asciiMatch[1].trim();
    return null;
  }

  async function submitAsDownload(form, defaultFilename, loadingMessage) {
    showLoading(loadingMessage);
    const formData = new FormData(form);

    const submitBtn = form.querySelector("button[type='submit']");
    if (submitBtn) submitBtn.disabled = true;

    try {
      const response = await fetch(form.action || window.location.href, {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      if (!response.ok) {
        const msg = await response.text();
        throw new Error(msg || "Server responded with an error.");
      }

      const blob = await response.blob();
      const disposition = response.headers.get("Content-Disposition");
      const filename = getFilenameFromDisposition(disposition) || defaultFilename;

      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;

      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error(err);
      alert(err?.message || "처리 중 오류가 발생했습니다.");
    } finally {
      if (submitBtn) submitBtn.disabled = false;
      hideLoading();
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const step1 = document.getElementById("step1-form");
    const step2 = document.getElementById("step2-form");
    const step3 = document.getElementById("step3-form");

    if (step1) step1.addEventListener("submit", (e) => {
      e.preventDefault();
      submitAsDownload(step1, "step1_result.xlsx", "Step 1 분석 중입니다...");
    });

    if (step2) step2.addEventListener("submit", (e) => {
      e.preventDefault();
      submitAsDownload(step2, "step2_result.xlsx", "Step 2 work sheet 분석 중입니다...");
    });

    if (step3) step3.addEventListener("submit", (e) => {
      e.preventDefault();
      submitAsDownload(step3, "master_updated.xlsx", "Step 3 마스터 반영 중입니다...");
    });
  });
</script>
</body>
</html>
