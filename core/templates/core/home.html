<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>월 PR 분석 자동반영</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f8fafc; --card:#fff; --line:#e2e8f0;
    --brand:#2563eb; --brand-light:#dbeafe;
    --text:#111827; --muted:#6b7280;
    --radius:16px; --shadow:0 10px 30px rgba(2,6,23,.06);
    --shadow2:0 16px 50px rgba(2,6,23,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Pretendard", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 420px at 12% 8%, rgba(37,99,235,.12), transparent 55%),
      radial-gradient(760px 420px at 90% 16%, rgba(37,99,235,.10), transparent 55%),
      radial-gradient(620px 380px at 60% 92%, rgba(15,23,42,.06), transparent 55%),
      var(--bg);
    overflow-x:hidden;
  }

  /* subtle moving noise */
  body::before{
    content:"";
    position:fixed; inset:0;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
    opacity:.06;
    pointer-events:none;
    mix-blend-mode:multiply;
    animation: floatNoise 10s linear infinite;
  }
  @keyframes floatNoise{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-2%, -3%, 0)}}

  .wrap{
    max-width:1200px;
    margin:54px auto;
    padding:0 22px 44px;
    position:relative;
    animation: pageIn .85s cubic-bezier(.16,1,.3,1) both;
  }
  @keyframes pageIn{
    0%{opacity:0; transform:translateY(14px) scale(.985)}
    100%{opacity:1; transform:translateY(0) scale(1)}
  }

  /* header */
  .hero{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:18px;
    margin-bottom:16px;
  }
  h1{
    font-size:28px;
    letter-spacing:-.02em;
    margin:0;
    font-weight:900;
    line-height:1.05;
  }
  .subtitle{
    margin:10px 0 0;
    color:var(--muted);
    font-size:14px;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border:1px solid rgba(37,99,235,.18);
    background:rgba(219,234,254,.55);
    color:#1d4ed8;
    border-radius:999px;
    font-weight:800;
    box-shadow:0 6px 18px rgba(37,99,235,.10);
    user-select:none;
    white-space:nowrap;
    transform:translateY(4px);
    animation: badgeFloat 2.2s ease-in-out infinite;
  }
  .badge .dot{
    width:9px; height:9px; border-radius:50%;
    background:#1d4ed8;
    box-shadow:0 0 0 0 rgba(37,99,235,.5);
    animation: dotPing 1.6s ease-out infinite;
  }
  @keyframes dotPing{
    0%{box-shadow:0 0 0 0 rgba(37,99,235,.45)}
    70%{box-shadow:0 0 0 12px rgba(37,99,235,0)}
    100%{box-shadow:0 0 0 0 rgba(37,99,235,0)}
  }
  @keyframes badgeFloat{
    0%,100%{transform:translateY(4px)}
    50%{transform:translateY(2px)}
  }

  /* step progress (top) */
  .steps{
    position:relative;
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:14px;
    margin:18px 0 18px;
    padding:14px;
    border:1px solid rgba(226,232,240,.9);
    border-radius:18px;
    background:rgba(255,255,255,.65);
    backdrop-filter: blur(10px);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .steps::before{
    content:"";
    position:absolute; inset:-60px -60px auto -60px;
    height:140px;
    background: radial-gradient(closest-side, rgba(37,99,235,.12), transparent 70%);
    animation: sweep 3.6s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes sweep{
    0%{transform:translateX(-12%)}
    50%{transform:translateX(18%)}
    100%{transform:translateX(-12%)}
  }
  .step{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(226,232,240,.85);
    background:rgba(255,255,255,.75);
    box-shadow:0 6px 20px rgba(2,6,23,.04);
    transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
    position:relative;
    overflow:hidden;
  }
  .step:hover{
    transform:translateY(-2px);
    box-shadow:0 14px 38px rgba(2,6,23,.10);
    border-color:rgba(37,99,235,.28);
  }
  .step::after{
    content:"";
    position:absolute; inset:0;
    background:linear-gradient(120deg, transparent 0%, rgba(37,99,235,.10) 28%, transparent 55%);
    transform:translateX(-120%);
    transition: transform .7s cubic-bezier(.16,1,.3,1);
    pointer-events:none;
  }
  .step:hover::after{transform:translateX(140%)}
  .circle{
    width:38px; height:38px;
    border-radius:999px;
    background:var(--brand-light);
    color:var(--brand);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    box-shadow:0 10px 24px rgba(37,99,235,.12);
    position:relative;
  }
  .circle::before{
    content:"";
    position:absolute; inset:-6px;
    border-radius:999px;
    background: radial-gradient(circle, rgba(37,99,235,.22), transparent 55%);
    opacity:.6;
    filter: blur(2px);
  }
  .step span{font-weight:900; letter-spacing:-.01em}

  /* === 3-column layout === */
  .tri{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:18px;
    align-items:stretch;
  }

  /* cards */
  .card{
    background:rgba(255,255,255,.82);
    border:1px solid rgba(226,232,240,.92);
    border-radius:var(--radius);
    padding:22px;
    box-shadow:var(--shadow);
    position:relative;
    overflow:hidden;
    min-height: 520px;
    transform: translateY(10px);
    opacity:0;
    animation: cardIn .9s cubic-bezier(.16,1,.3,1) both;
  }
  .card:nth-child(1){animation-delay:.08s}
  .card:nth-child(2){animation-delay:.16s}
  .card:nth-child(3){animation-delay:.24s}
  @keyframes cardIn{
    0%{opacity:0; transform:translateY(14px) scale(.985)}
    100%{opacity:1; transform:translateY(0) scale(1)}
  }
  .card::before{
    content:"";
    position:absolute; inset:-2px;
    background: linear-gradient(135deg, rgba(37,99,235,.16), transparent 36%, rgba(37,99,235,.10));
    opacity:.45;
    pointer-events:none;
  }
  .card::after{
    content:"";
    position:absolute; top:-60px; right:-60px;
    width:220px; height:220px;
    border-radius:999px;
    background: radial-gradient(circle, rgba(37,99,235,.14), transparent 65%);
    pointer-events:none;
    animation: orb 6s ease-in-out infinite;
  }
  @keyframes orb{
    0%,100%{transform:translate3d(0,0,0)}
    50%{transform:translate3d(-18px, 14px,0)}
  }
  .card:hover{
    box-shadow:var(--shadow2);
    transform:translateY(-2px);
    transition: transform .18s ease, box-shadow .22s ease;
  }

  .card h2{
    font-size:18px;
    margin:0 0 10px;
    letter-spacing:-.02em;
    position:relative;
    z-index:1;
  }
  .card p{
    color:var(--muted);
    font-size:14px;
    margin:0 0 16px;
    position:relative;
    z-index:1;
  }

  /* form */
  form{display:flex; flex-direction:column; gap:10px; position:relative; z-index:1;}
  label{
    font-weight:900;
    font-size:13px;
    margin:8px 0 0;
    letter-spacing:-.01em;
  }
  input[type="file"], input[type="number"], input[type="text"]{
    width:100%;
    padding:12px 12px;
    border:1px solid rgba(226,232,240,.95);
    border-radius:12px;
    background:rgba(255,255,255,.96);
    outline:none;
    box-shadow:0 1px 0 rgba(15,23,42,.02) inset;
    transition: box-shadow .25s ease, border-color .25s ease, transform .15s ease;
  }
  input[type="file"]{padding:10px}
  input:focus{
    border-color:rgba(37,99,235,.45);
    box-shadow:0 0 0 5px rgba(37,99,235,.12);
  }
  input:active{transform:scale(.995)}

  button{
    margin-top:8px;
    padding:12px 16px;
    border:none;
    border-radius:12px;
    font-weight:900;
    letter-spacing:-.01em;
    color:#fff;
    background: linear-gradient(180deg, #2563eb 0%, #1d4ed8 100%);
    cursor:pointer;
    width:100%;
    position:relative;
    overflow:hidden;
    box-shadow:0 14px 30px rgba(37,99,235,.20);
    transform: translateZ(0);
    transition: transform .18s ease, box-shadow .22s ease, filter .22s ease;
  }
  button:hover{
    transform: translateY(-1px);
    box-shadow:0 20px 44px rgba(37,99,235,.28);
    filter:saturate(1.05);
  }
  button:active{transform: translateY(0px) scale(.99)}
  button[disabled]{
    background:#cbd5e1;
    color:#f1f5f9;
    cursor:not-allowed;
    box-shadow:none;
  }
  button::after{
    content:"";
    position:absolute; inset:-40%;
    background: radial-gradient(circle, rgba(255,255,255,.28), transparent 55%);
    transform:translateX(-70%) rotate(18deg);
    transition: transform .9s cubic-bezier(.16,1,.3,1);
  }
  button:hover::after{transform:translateX(70%) rotate(18deg)}

  .footer{
    text-align:center;
    color:#94a3b8;
    font-size:12px;
    margin-top:28px;
    animation: fadeUp .8s ease .35s both;
  }
  @keyframes fadeUp{
    0%{opacity:0; transform:translateY(8px)}
    100%{opacity:1; transform:translateY(0)}
  }

  /* Loading overlay */
  .loading-overlay{
    position:fixed; inset:0;
    background:
      radial-gradient(1200px 520px at 15% 10%, rgba(37,99,235,.12), transparent 55%),
      radial-gradient(900px 480px at 90% 20%, rgba(37,99,235,.10), transparent 55%),
      rgba(248,250,252,.86);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9999;
    opacity:0;
    pointer-events:none;
    transition: opacity .25s ease;
    backdrop-filter: blur(10px);
  }
  .loading-overlay.active{opacity:1; pointer-events:auto;}
  .loader-text{
    font-size:18px;
    font-weight:900;
    margin-bottom:18px;
    color:var(--brand);
    letter-spacing:-.02em;
    text-align:center;
    animation: breathe 1.4s ease-in-out infinite;
  }
  @keyframes breathe{
    0%,100%{transform:translateY(0); opacity:1}
    50%{transform:translateY(-2px); opacity:.85}
  }
  .progress-shell{
    width:min(420px, 86vw);
    padding:14px;
    border-radius:18px;
    border:1px solid rgba(226,232,240,.85);
    background:rgba(255,255,255,.72);
    box-shadow:var(--shadow2);
    overflow:hidden;
    position:relative;
  }
  .progress-shell::before{
    content:"";
    position:absolute; inset:-2px;
    background: linear-gradient(135deg, rgba(37,99,235,.18), transparent 40%, rgba(37,99,235,.14));
    opacity:.55;
    pointer-events:none;
  }
  .progress-bar{
    width:100%;
    height:12px;
    background:#e5e7eb;
    border-radius:999px;
    overflow:hidden;
    box-shadow:0 0 0 1px rgba(148,163,184,.35) inset;
    position:relative;
  }
  .progress-inner{
    width:38%;
    height:100%;
    background: linear-gradient(90deg, #2563eb, #1d4ed8);
    animation: indeterminate 1.1s infinite ease-in-out;
    transform: translateX(-120%);
  }
  @keyframes indeterminate{
    0%{ transform: translateX(-120%); }
    100%{ transform: translateX(280%); }
  }

  /* responsive */
  @media (max-width: 1060px){
    .tri{grid-template-columns:1fr; }
    .card{min-height:auto}
    .badge{display:none}
  }
  @media (prefers-reduced-motion: reduce){
    *{animation:none !important; transition:none !important; scroll-behavior:auto !important}
    body::before{display:none}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div>
      <h1>PR Tracking System</h1>
      <p class="subtitle">업로드 → 검수 → 마스터 반영까지 한 화면에서 끝냅니다.</p>
    </div>
    <div class="badge"><span class="dot"></span> Live Pipeline</div>
  </div>

  <!-- Step Progress -->
  <div class="steps">
    <div class="step"><div class="circle">1</div><span>자동 분류</span></div>
    <div class="step"><div class="circle">2</div><span>work sheet 분석</span></div>
    <div class="step"><div class="circle">3</div><span>★ 마스터 파일 업데이트</span></div>
  </div>

  <!-- 3 columns -->
  <div class="tri">
    <!-- Step 1 -->
    <div class="card">
      <h2>Step 1. raw data & "월 PR 분석.xslx" 파일 업로드</h2>
      <p>자동으로 시트명·기간·카테고리를 반영한 결과 파일을 생성합니다.</p>
      <form id="step1-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="step" value="1">
        <label>월 (1-12)</label>
        {{ form.month }}
        <label>raw data File</label>
        {{ form.raw_file }}
        <label>월 PR 분석 File</label>
        {{ form.monthly_file }}
        <button type="submit">분석 실행 & 다운로드</button>
      </form>
    </div>

    <!-- Step 2 -->
    <div class="card">
      <h2>Step 2. 검수본 업로드</h2>
      <p>Step 1에서 다운 받은 파일에서 "미분류" 카테고리 검수 후 업로드. <br/>*_work 시트를 분석합니다.</p>
      <form id="step2-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="step" value="2">
        <label>검수 완료 파일</label>
        <input type="file" name="checked_file" accept=".xlsx" required>
        <button type="submit">월 PR Tracking File 완성본 다운로드</button>
      </form>
    </div>

    <!-- Step 3 -->
    <div class="card">
      <h2>Step 3. 마스터 반영</h2>
      <p>검수 완료본과 마스터 파일을 업로드해 최종 반영본을 만듭니다.</p>
      <form id="step3-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="step" value="3">
        <label>검수 완료 파일</label>
        <input type="file" name="checked_file_step3" accept=".xlsx" required>
        <label>마스터 파일</label>
        <input type="file" name="master_file" accept=".xlsx" required>
        <label>기간 (예: Dec-25)</label>
        <input type="text" name="period" placeholder="Dec-25" required
               pattern="^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-\d{2}$">
        <button type="submit">Master File Download</button>
      </form>
    </div>
  </div>

  <div class="footer">© 2025 PR Auto Analysis</div>
</div>

<!-- 로딩 오버레이 -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loader-text" id="loader-text">분석 중입니다...</div>
  <div class="progress-shell">
    <div class="progress-bar"><div class="progress-inner"></div></div>
  </div>
</div>

<script>
  function showLoading(message) {
    const overlay = document.getElementById("loading-overlay");
    const text = document.getElementById("loader-text");
    if (text && message) text.textContent = message;
    if (overlay) overlay.classList.add("active");
  }

  function hideLoading() {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) overlay.classList.remove("active");
  }

  function getFilenameFromDisposition(disposition) {
    if (!disposition) return null;
    const utf8Match = disposition.match(/filename\*\s*=\s*UTF-8''([^;]+)/i);
    if (utf8Match && utf8Match[1]) {
      try { return decodeURIComponent(utf8Match[1].replace(/['"]/g, "").trim()); } catch(e) {}
    }
    const asciiMatch = disposition.match(/filename\s*=\s*"?([^"]+)"?/i);
    if (asciiMatch && asciiMatch[1]) return asciiMatch[1].trim();
    return null;
  }

  async function submitAsDownload(form, defaultFilename, loadingMessage) {
    showLoading(loadingMessage);
    const formData = new FormData(form);

    const submitBtn = form.querySelector("button[type='submit']");
    if (submitBtn) submitBtn.disabled = true;

    try {
      const response = await fetch(form.action || window.location.href, {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      if (!response.ok) {
        const msg = await response.text();
        throw new Error(msg || "Server responded with an error.");
      }

      const blob = await response.blob();
      const disposition = response.headers.get("Content-Disposition");
      const filename = getFilenameFromDisposition(disposition) || defaultFilename;

      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;

      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error(err);
      alert(err?.message || "처리 중 오류가 발생했습니다.");
    } finally {
      if (submitBtn) submitBtn.disabled = false;
      hideLoading();
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const step1 = document.getElementById("step1-form");
    const step2 = document.getElementById("step2-form");
    const step3 = document.getElementById("step3-form");

    if (step1) step1.addEventListener("submit", (e) => {
      e.preventDefault();
      submitAsDownload(step1, "step1_result.xlsx", "Step 1 분석 중입니다...");
    });

    if (step2) step2.addEventListener("submit", (e) => {
      e.preventDefault();
      submitAsDownload(step2, "step2_result.xlsx", "Step 2 work sheet 분석 중입니다...");
    });

    if (step3) step3.addEventListener("submit", (e) => {
      e.preventDefault();
      submitAsDownload(step3, "master_updated.xlsx", "Step 3 마스터 반영 중입니다...");
    });
  });
</script>
</body>
</html>
